// nextflow.config

// ==================== PARAMETERS ====================
params.reads = "/nfs/research/jlees/ines/wgs/data/rawfastq/*_{1,2}.fastq.gz"
params.outdir = "/nfs/research/jlees/ines/wgs/data/outputs"

params.kraken_db = "/hps/nobackup/jlees/ines/k2_eupathdb48_20230407"

params.reference_map = "/nfs/research/jlees/ines/pipelines/test/reference/bwa-index/Pf3D7_v3.fasta"
params.reference_variant = "/nfs/research/jlees/ines/pipelines/test/reference/gatk-index/Pf3D7_v3.fasta"
params.reference_chromsplit = "/nfs/research/jlees/ines/pipelines/test/reference/chrom-split/Pf3D7_v3.fasta"

params.snpeff_db = "Plasmodium_falciparum"
params.snpeff_data = "/nfs/research/jlees/ines/pipelines/test/results/snpeff_data"

params.mask_bed = "/nfs/research/jlees/ines/pipelines/test/masked-ref/Pf3D7_pooled_mask.bed"

params.tmpdir = "${params.outdir}/gatk_temp" // GATK temp dir
params.pl = 'ILLUMINA' // Platform (for read groups)
params.pm = 'Nextseq' // Platform model

// Pf3D7_v3 contig names: 14 nuclear + mitochondrion + apicoplast
params.chroms = [
    "Pf3D7_01_v3", "Pf3D7_02_v3", "Pf3D7_03_v3", "Pf3D7_04_v3",
    "Pf3D7_05_v3", "Pf3D7_06_v3", "Pf3D7_07_v3", "Pf3D7_08_v3",
    "Pf3D7_09_v3", "Pf3D7_10_v3", "Pf3D7_11_v3", "Pf3D7_12_v3",
    "Pf3D7_13_v3", "Pf3D7_14_v3",
    "Pf3D7_MIT_v3", "Pf3D7_API_v3"
]

// ====================Work Directory ====================
// Store work directory
workDir = "/nfs/research/jlees/ines/wgs/data/work"

// ----------------------------------------------------------------------
// EXECUTOR CONFIG → SLURM
// Call with:  nextflow run main.nf -profile slurm
// ----------------------------------------------------------------------
profiles {

    slurm {

        // Default process settings for this profile
        process {
            executor        = 'slurm'
            clusterOptions  = '--job-name=NF-${task.process}'

            cpus            = 8
            memory          = '32 GB'
            time            = '2h'
            maxForks        = 50

            // Process-specific resource overrides
            withName: 'FASTQC_RAW' {
                cpus    = 2
                memory  = '4 GB'
                time    = '1h'
            }

            withName: 'MULTIQC_RAW' {
                cpus    = 2
                memory  = '4 GB'
                time    = '30m'
            }

            withName: 'FASTP_TRIM' {
                cpus    = 4
                memory  = '8 GB'
                time    = '2h'
            }

            withName: 'FASTQC_TRIM' {
                cpus    = 2
                memory  = '4 GB'
                time    = '1h'
            }

            withName: 'MULTIQC_TRIM' {
                cpus    = 2
                memory  = '4 GB'
                time    = '30m'
            }

            withName: 'KRAKEN2_CLASSIFY' {
                cpus    = 8
                memory  = '64 GB'   // Kraken2 needs lots of RAM
                time    = '4h'
            }

            withName: 'BWA_MEM_MAP' {
                cpus    = 8
                memory  = '16 GB'
                time    = '6h'
            }

            withName: 'ALIGNMENT_QC_MAP' {
                cpus   = 4
                memory = '16 GB'
                time   = '3h'
            }

            withName: 'MULTIQC_MAP' {
                cpus   = 2
                memory = '8 GB'
                time   = '30m'
            }

            withName: 'MARK_DUPLICATES' {
                cpus   = 4
                memory = '32 GB'
                time   = '4h'
            }

            withName: 'HAPLOTYPE_CALLER' {
                cpus   = 8
                memory = '32 GB'
                time   = '12h'
            }

            withName: 'GENOTYPE_GVCF' {
                cpus   = 8
                memory = '32 GB'
                time   = '12h'
            }

            withName: 'SELECT_VARIANTS' {
                cpus   = 2
                memory = '8 GB'
                time   = '2h'
            }

            withName: 'FILTER_SNPs' {
                cpus   = 2
                memory = '8 GB'
                time   = '2h'
            }

            withName: 'FILTER_INDELs' {
                cpus   = 2
                memory = '8 GB'
                time   = '2h'
            }

            withName: 'MASK_SNP_VARIANTS' {
                cpus   = 4
                memory = '16 GB'
                time   = '2h'
            }

            withName: 'MASK_INDEL_VARIANTS' {
                cpus   = 4
                memory = '16 GB'
                time   = '2h'
            }

            withName: 'SNPEFF_Annotate_SNPs' {
                cpus   = 4
                memory = '32 GB'
                time   = '3h'
            }

            withName: 'SNPEFF_Annotate_INDELs' {
                cpus   = 4
                memory = '32 GB'
                time   = '3h'
            }

            withName: 'SPLIT_ANNOTATED_SNPS_BY_CHROM' {
                cpus   = 8
                memory = '32 GB'
                time   = '2h'
            }

            withName: ' SPLIT_ANNOTATED_INDELS_BY_CHROM' {
                cpus   = 8
                memory = '32 GB'
                time   = '2h'
            }

        // Error strategy – retry failed jobs
            errorStrategy   = 'retry'
            maxRetries      = 2
        }

        // SLURM executor-level options
        executor {
            queueSize       = 200
            submitRateLimit = '50/1min'
            pollInterval    = '30 sec'
        }

        // Optional: queue/partition if your cluster uses them
        // process.queue = 'short'

        // Conda support
        conda {
            enabled  = true
            cacheDir = "/nfs/research/jlees/ines/pipelines/.conda"
        }

        // Singularity (disabled here)
        singularity {
            enabled   = false
            autoMounts = true
        }

        // Run reports
        timeline {
            enabled = true
            file    = "${params.outdir}/timeline.html"
            overwrite = true
        }

        trace {
            enabled = true
            file    = "${params.outdir}/trace.txt"
        }

        report {
            enabled = true
            file    = "${params.outdir}/report.html"
            fields  = 'task_id,hash,native_id,process,tag,name,status,exit,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar'
            overwrite = true
        }

        dag {
            enabled = true
            file    = "${params.outdir}/dag.png"
        }
    }
}

